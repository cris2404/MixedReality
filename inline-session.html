<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <link rel='stylesheet' href='css/common.css'>
  <title>Inline Session</title>
</head>
<body>
  <header>
    <details open>
      <summary>Inline Session</summary>
      <p>
        This sample demonstrates the use of an 'inline' XRSession to present
        content on the page prior to entering XR presentation with an
        immersive session.
        <a class="back" href="./">Back</a>
      </p>
      <button id="startVR">Start VR</button>
      <button id="startAR">Start AR</button>
    </details>
  </header>
  <script type="module">
    import { createWebGLContext } from './js/render/core/renderer.js';

    let inlineSession = null;
    let immersiveSession = null;
    let gl = null;
    let xrRefSpace = null;

    async function initXR() {
      if (!navigator.xr) {
        alert("WebXR is not supported in your browser.");
        return;
      }

      document.getElementById('startVR').addEventListener('click', () => startSession('immersive-vr'));
      document.getElementById('startAR').addEventListener('click', () => startSession('immersive-ar'));

      navigator.xr.isSessionSupported('immersive-vr').then(supported => {
        document.getElementById('startVR').disabled = !supported;
      });

      navigator.xr.isSessionSupported('immersive-ar').then(supported => {
        document.getElementById('startAR').disabled = !supported;
      });

      // Start inline session
      navigator.xr.requestSession('inline').then(session => {
        inlineSession = session;
        setupGL();
        setupSession(session);
      });
    }

    function setupGL() {
      if (!gl) {
        gl = createWebGLContext({ xrCompatible: true });
        document.body.appendChild(gl.canvas);
        gl.canvas.style.width = '100%';
        gl.canvas.style.height = '100%';
      }
    }

    async function startSession(mode) {
      if (!navigator.xr) return;

      immersiveSession = await navigator.xr.requestSession(mode);
      immersiveSession.addEventListener('end', () => {
        immersiveSession = null;
      });

      setupSession(immersiveSession);
    }

    async function setupSession(session) {
      if (!gl) setupGL();
    
      session.updateRenderState({
        baseLayer: new XRWebGLLayer(session, gl)
      });
    
      try {
        xrRefSpace = await session.requestReferenceSpace('local');
      } catch (e) {
        console.warn("Falling back to 'viewer' reference space:", e);
        xrRefSpace = await session.requestReferenceSpace('viewer');
        }

      session.requestAnimationFrame((time, frame) => onXRFrame(session, time, frame));
    }


    function onXRFrame(session, time, frame) {
      const pose = frame.getViewerPose(xrRefSpace);

      if (pose) {
        const glLayer = session.renderState.baseLayer;
        gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      }

      session.requestAnimationFrame((time, frame) => onXRFrame(session, time, frame));
    }

    initXR();
  </script>
</body>
</html>
