<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>
    <title>Inline Session with AR and VR</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>Inline Session with AR and VR</summary>
        <p>
          This sample demonstrates the use of 'inline', AR, and VR sessions. 
          You can adjust the viewer pose using mouse or touch for inline sessions.
          <a class="back" href="./">Back</a>
          <p>
            <input id='vertFOV' value='90' min='30' max='150' step='10' type='range'/><br/>
            <label id='vertFOVLabel' for="vertFOV">Vertical FOV: </label>
          </p>
        </p>
      </details>
    </header>
    <script type="module">
      import {WebXRButton} from './js/util/webxr-button.js';
      import {Scene} from './js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
      import {Gltf2Node} from './js/render/nodes/gltf2.js';
      import {SkyboxNode} from './js/render/nodes/skybox.js';
      import {mat4, vec3, quat} from './js/render/math/gl-matrix.js';
      import {QueryArgs} from './js/util/query-args.js';

      import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';
      if (QueryArgs.getBool('usePolyfill', true)) {
        new WebXRPolyfill();
      }

      let inlineSession = null;
      let xrButtonVR = null;
      let xrButtonAR = null;
      let xrImmersiveRefSpace = null;
      let xrInlineRefSpace = null;

      let gl = null;
      let renderer = null;
      let scene = new Scene();
      let solarSystem = new Gltf2Node({url: 'media/gltf/space/space.gltf'});
      scene.addNode(solarSystem);
      scene.addNode(new SkyboxNode({url: 'media/textures/milky-way-4k.png'}));

      function initXR() {
        xrButtonVR = new WebXRButton({
          onRequestSession: () => onRequestSession('immersive-vr'),
          onEndSession: onEndSession
        });
        xrButtonAR = new WebXRButton({
          onRequestSession: () => onRequestSession('immersive-ar'),
          onEndSession: onEndSession
        });

        document.querySelector('header').appendChild(xrButtonVR.domElement);
        document.querySelector('header').appendChild(xrButtonAR.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
            xrButtonVR.enabled = supported;
          });
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            xrButtonAR.enabled = supported;
          });

          navigator.xr.requestSession('inline').then((session) => {
            inlineSession = session;
            onSessionStarted(session);
          });
        }
      }

      function onRequestSession(type) {
        return navigator.xr.requestSession(type).then((session) => {
          const button = type === 'immersive-vr' ? xrButtonVR : xrButtonAR;
          button.setSession(session);
          session.isImmersive = true;
          onSessionStarted(session);
        });
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        if (!gl) {
          gl = createWebGLContext({xrCompatible: true});
          document.body.appendChild(gl.canvas);
          window.addEventListener('resize', onResize);
          onResize();
          addInlineViewListeners(gl.canvas);
          renderer = new Renderer(gl);
          scene.setRenderer(renderer);
        }

        let glLayer = new XRWebGLLayer(session, gl);
        session.updateRenderState({baseLayer: glLayer});

        let refSpaceType = session.isImmersive ? 'local' : 'viewer';
        session.requestReferenceSpace(refSpaceType).then((refSpace) => {
          if (session.isImmersive) xrImmersiveRefSpace = refSpace;
          else xrInlineRefSpace = refSpace;
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        const button = event.session.renderState.baseLayer.sessionType === 'immersive-vr' 
            ? xrButtonVR : xrButtonAR;
        button.setSession(null);
      }

      function onXRFrame(t, frame) {
        let session = frame.session;
        let refSpace = session.isImmersive ? xrImmersiveRefSpace : xrInlineRefSpace;
        if (!session.isImmersive) refSpace = getAdjustedRefSpace(refSpace);

        let pose = frame.getViewerPose(refSpace);

        scene.startFrame();
        session.requestAnimationFrame(onXRFrame);

        if (pose) {
          let glLayer = session.renderState.baseLayer;
          gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
          gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

          for (let view of pose.views) {
            let viewport = glLayer.getViewport(view);
            gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
            scene.draw(view.projectionMatrix, view.transform);
          }
        }

        scene.endFrame();
      }

      function onResize() {
        gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
        gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
      }

      initXR();
    </script>
  </body>
</html>
